### 问项目经验

### 问学习方法

### 问从浏览器输入URL到渲染出页面发生了什么

面试官问的非常仔细，我回答的太粗糙了，没有深入的去说各个步骤的细节，然后面试官会给予补充，感觉面试官说的比我说的还多，凉凉。

复习一下，从浏览器输入URL到渲染出页面到底发什么什么呢？

1. 检查缓存

    在真正的向服务器发起请求之前，先要检查是否有该资源的缓存，浏览器中的缓存分为两种，一种为强缓存，另一种是协商缓存。

    - 强缓存

    强缓存也叫强制缓存，

2. HSTS（HTTP Strict Transport Security） 强制客户端使用HTTPS访问页面。 https://www.barretlee.com/blog/2015/10/22/hsts-intro/

如果之前服务器返回的响应头有Strict-Tranport-Security （可以设置MaxAge），那么用户下次如果使用HTTP进行访问，那么客户端内部会自动进行跳转使用HTTPS来访问，响应码是307（不用向服务器发起请求由服务器重定向）

1. 找到域名對應的IP地址。

    首先調用瀏覽器的DNS緩存，如果没有的话就找本地hosts文件，檢查在該文件中是否有對應的域名，（如果浏览器先访问了一个不存在的域名，然后在hosts中添加了对应的ip地址，那么结果还是访问不到）如果路由器中设置了dns缓存的话会在路由器中查找，如果还没有找到就会请求本地DNS服务器（一般是运营商）如果本地DNS服务器中仍然没有缓存，那么本地DNS服务器会去迭代搜索，首先向根DNS服务器中查找，根DNS服务器会根据后缀告知本地DNS服务器下一次查询的域名服务器，然后这样迭代查询，直到储存了这个域名所在IP地址的权限DNS服务器告知本地DNS服务器对应的IP地址。
    ![](https://segmentfault.com/img/bVYTXW?w=805&h=478)

2. 建立TCP连接

    建立TCP连接之前，有没有想过我们的客户端是如何找到服务器IP所在的具体位置的呢？这里就用到了网络层的IP协议，网络层的核心功能是**转发**与**路由**

    转发(forwarding):将分组从路由器的输入端口转移到合适的输出端口

    路由(routing): 确定分组从源到目的经过的路径。

    首先判断目标地址是否与当前地址处于同一网络中，是的话直接根据 Mac 地址发送，否则使用路由表查找下一跳地址，以及使用 ARP 协议查询它的 Mac 地址。
    
    网络层分片传输，转发表中按照最长匹配策略进行转发。

    这里不去进行详细解释网络层的转发规则，有兴趣的同学可以自己查阅相关资料。

    下面进入正题，浏览器向服务器发起建立TCP连接的请求，开始三次握手。首先浏览器向服务器发送的数据包中带有SYN标志，同时携带浏览器随机生成的seq = p序列号，服务器收到数据包后，回传一个带有SYN和ACK标志的数据包表示确认信息，同时携带seq = q，ack = p + 1的序列号和确认码，表示成功收到了序列号为p的数据包，下一个传过来的数据包的序列号应该是p + 1，然后浏览器收到确认信息之后，再回传一个带有ACK标志的数据包，同时携带seq = p + 1，ack = q + 1 的序列号和确认码，表示收到了序列号为q的数据包，这个数据包的序列号为p + 1。三次握手完成。

    为什么需要三次握手呢？ 防止失效报文段到达服务端，浪费资源

3. 发送HTTP请求

    建立了TCP连接之后就可以向服务器发起HTTP请求了，这里**HTTP报文结构**需要注意。

4. 服务器处理请求

    服务器接收到HTTP请求之后会对报文进行解析，如果服务器配置了重定向，那么就会返回一个301来永久重定向响应，告知客户端重新发送HTTP请求。

    然后查看URL重写规则，如果请求的是一个真实存在的文件，那么服务器会直接把这个文件返回。否则服务器会根据规则把请求重写到一个REST风格的URL上，之后决定调用什么类型的解释器来处理这个请求。

5. 浏览器接受响应

    浏览器接收到来自服务器的响应之后，对资源进行解析。首先根据响应码得知这个请求的返回状态并作相应的处理（比如重定向操作或者404等）。如果资源进行了压缩（如gzip）那么要先进行解压。 然后按照响应头做缓存。接下来根据响应资源中的MIME（Multipurpose Internet Mail Extensions）类型解析响应的内容。

6. 渲染页面

    解码 将二进制的数据根据文件指定的编码规则转换成字符串。

    预解析 会识别一些资源文件的属性例如HTML中引用到的一些图片，并将这些请求加入到请求队列中。

    词法分析（符号化） 将输入解析成符号，HTML 符号包括，开始标签、结束标签、属性名和属性值。

    语法分析，根据状态机解析出DOM语句并构建DOM树，这个过程和词法分析是一起执行的，也就是说词法分析得到一个开始标签，就会新建一个DOM节点。

    当整个解析的过程完成以后，浏览器会通过DOMContentLoaded事件来通知DOM解析完成。

    同时加载CSS文件，解析并构建CSSOM树

    如果遇到JS文件，那么将会等待JS加载完成之后再继续DOM树或者CSSOM树的构建。 （JS 的 defer 和 async 属性，defer可以按照顺序执行JS脚本）

    在解析CSSOM树和DOM树的同时，渲染树也在并行的进行构建。最后浏览器调用渲染器在页面上显示渲染树最终渲染出的位图。当然，在渲染的过程中浏览器也会进行一些优化，比如浏览器会预先猜测一些节点不会改变，从而把他们合成到一张位图上。

7. JS编译执行

    词法分析

    - 分词，例如将var a = 2，，分成var、a、=、2这样的词法单元。
    - 解析，将词法单元转换成抽象语法树（AST）。
    - 代码生成，将抽象语法树转换成机器指令。

    预编译
    - 创建执行上下文

    执行

